# 🐳 サンドボックスサービス使用ガイド

## 📋 概要
このサンドボックスサービスは、DockerコンテナでPythonコードを安全に実行するためのサービスです。

## ✨ 主な機能
- **安全な実行環境**: Dockerコンテナでコードを分離実行
- **セキュリティ制限**: ネットワーク無効、メモリ制限（128MB）
- **タイムアウト制御**: 5秒でタイムアウト
- **エラーハンドリング**: 構文エラー、実行時エラーの詳細検出
- **標準入力サポート**: stdinによる入力データの受け渡し
- **同期・非同期実行**: 両方のモードをサポート

## 🚀 基本的な使用方法

### 1. インポート
```python
from services.sandbox_service import (
    execute_python_code_sync,      # 同期実行
    execute_python_code_in_docker, # 非同期実行
    CodeExecutionResult            # 結果の型
)
```

### 2. 同期実行の例
```python
# 基本的なコード実行
result = execute_python_code_sync('print("Hello, World!")')
print(f"出力: {result.stdout}")
print(f"成功: {result.succeeded}")
print(f"実行時間: {result.execution_time_ms}ms")
```

### 3. 非同期実行の例
```python
import asyncio

async def main():
    result = await execute_python_code_in_docker('print("Hello, Async!")')
    print(f"出力: {result.stdout}")

asyncio.run(main())
```

## 📝 実行結果の構造

`CodeExecutionResult`型には以下の情報が含まれます：

```python
class CodeExecutionResult:
    stdout: str              # 標準出力
    stderr: str              # エラー出力
    execution_time_ms: float # 実行時間（ミリ秒）
    exit_code: int           # 終了コード
    error_type: str | None   # エラータイプ
    succeeded: bool          # 実行成功判定
```

## 💡 使用例

### 基本的なコード実行
```python
result = execute_python_code_sync('''
print("Hello, World!")
x = 10 + 20
print(f"計算結果: {x}")
''')

if result.succeeded:
    print("実行成功!")
    print(f"出力: {result.stdout}")
else:
    print("実行失敗")
    print(f"エラー: {result.stderr}")
```

### 標準入力を使用
```python
code = '''
name = input("お名前を入力してください: ")
age = int(input("年齢を入力してください: "))
print(f"こんにちは、{name}さん！")
print(f"あなたは{age}歳ですね。")
'''

# 入力データを準備
stdin_data = "田中太郎\n25\n"

result = execute_python_code_sync(code, stdin_input=stdin_data)
print(f"出力:\n{result.stdout}")
```

### エラーハンドリング
```python
# ゼロ除算エラーの例
result = execute_python_code_sync('x = 1 / 0')

print(f"成功: {result.succeeded}")
print(f"エラータイプ: {result.error_type}")  # "ZeroDivisionError"
print(f"エラー内容: {result.stderr}")
```

### 複雑な計算の例
```python
code = '''
def fibonacci(n):
    if n <= 1:
        return n
    return fibonacci(n-1) + fibonacci(n-2)

# 最初の10個のフィボナッチ数を計算
fib_numbers = [fibonacci(i) for i in range(10)]
print(f"フィボナッチ数列: {fib_numbers}")

# 平均を計算
average = sum(fib_numbers) / len(fib_numbers)
print(f"平均: {average:.2f}")
'''

result = execute_python_code_sync(code)
print(f"出力:\n{result.stdout}")
print(f"実行時間: {result.execution_time_ms:.2f}ms")
```

## 🔍 検出可能なエラータイプ

- `TimeoutError`: 5秒でタイムアウト
- `SyntaxError`: 構文エラー
- `NameError`: 未定義変数の使用
- `TypeError`: 型エラー  
- `ValueError`: 値エラー
- `IndexError`: インデックスエラー
- `KeyError`: キーエラー
- `ZeroDivisionError`: ゼロ除算エラー
- `RuntimeError`: その他の実行時エラー

## ⚠️ セキュリティ制限

このサンドボックスには以下のセキュリティ制限があります：

- **ネットワークアクセス無効**: 外部接続不可
- **メモリ制限**: 128MBまで
- **実行時間制限**: 5秒でタイムアウト
- **ファイルシステム**: 読み取り専用

## 🧪 テストの実行

実装されたテストファイルを使用してサービスを検証できます：

```bash
# 基本テスト
python simple_sandbox_test.py

# 完全なテスト
python test_sandbox_complete.py

# 使用例の実行
python example_usage.py
```

## 🔧 トラブルシューティング

### Dockerが見つからない場合
```bash
# Docker デーモンが実行中か確認
docker --version
docker ps

# Dockerイメージのプル
docker pull python:3.11-slim
```

### ImportError が発生する場合
```python
import sys
import os
sys.path.append(os.path.dirname(__file__))
```

## 📚 参考資料

- [Docker SDK for Python](https://docker-py.readthedocs.io/)
- [Pydantic Models](https://docs.pydantic.dev/)
- 実装ファイル: `backend/services/sandbox_service.py`
- テストファイル: `backend/test_sandbox_complete.py`
- 使用例: `backend/example_usage.py`
